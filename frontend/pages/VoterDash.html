<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Voting System - Voter Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f1f5f9;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            position: fixed;
            width: 250px;
            height: 100vh;
            background-color: #1e3a8a;
            color: white;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            font-size: 1.8rem;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            flex: 1;
        }

        .sidebar li {
            margin: 1rem 0;
        }

        .sidebar a {
            text-decoration: none;
            color: white;
            font-size: 1.1rem;
            display: block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #3b82f6;
        }

        .logout-btn {
            margin-top: 2rem;
            background-color: #ef4444;
            border: none;
            padding: 0.8rem;
            font-size: 1.1rem;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #dc2626;
        }

        .main-content {
            margin-left: 250px;
            padding: 2.5rem;
            width: calc(100% - 250px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .main-content h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .bg-white {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .bg-white:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .bg-white h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .bg-white p {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .countdown {
            font-size: 2rem;
            font-weight: bold;
        }

        canvas {
            width: 100%;
            height: 300px;
            margin-top: 2rem;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: #10b981;
            color: white;
        }

        .badge-warning {
            background-color: #f59e0b;
            color: white;
        }

        .badge-pending {
            background-color: #6b7280;
            color: white;
        }

        .vote-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .vote-btn:hover {
            background-color: #2563eb;
        }

        .vote-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

    /* Update the featured election container to allow scrolling */
    #featuredelection {
        max-height: 400px; /* Adjust the height based on your preference */
        overflow-y: auto;  /* Allow vertical scrolling if the content exceeds the max-height */
        padding-right: 1rem; /* Add some padding to avoid content touching the right edge */
    }

    #featuredelection .election-card {
        background-color: #f7fafc; /* Slightly lighter background */
        padding: 1.25rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem; /* Space between each election */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    #featuredelection .election-card:hover {
        transform: scale(1.02); /* Slightly scale up on hover */
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* Add a stronger shadow */
    }

    #featuredelection h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333333;
    }

    #featuredelection p {
        color: #4a5568;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    #featuredelection .text-sm {
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* FAQ Modal */
.faq-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    overflow-y: auto;
}

.faq-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    width: 80%;
    max-width: 800px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    position: relative;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-50px); }
    to { opacity: 1; transform: translateY(0); }
}

.faq-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 28px;
    font-weight: bold;
    color: #6b7280;
    cursor: pointer;
    transition: color 0.2s;
}

.faq-close:hover {
    color: #111827;
}

.faq-card {
    margin-bottom: 16px;
    border-radius: 8px;
    overflow: hidden;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.faq-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.faq-question {
    padding: 16px;
    font-weight: 600;
    background-color: #f3f4f6;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.faq-question:after {
    content: '+';
    font-size: 20px;
    transition: transform 0.3s ease;
}

.faq-card.active .faq-question:after {
    content: 'âˆ’';
}

.faq-answer {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
}

.faq-card.active .faq-answer {
    padding: 16px;
    max-height: 500px;
}

.faq-search {
    width: 100%;
    padding: 10px 16px;
    margin-bottom: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s;
}

.faq-search:focus {
    outline: none;
    border-color: #3b82f6;
}

.faq-category {
    margin-bottom: 24px;
}

.faq-category-title {
    font-size: 18px;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}


        /* Flexbox container for splitting the sections */
        .flex {
            display: flex;
        }

        .space-x-6 {
            gap: 1.5rem;
        }

        .flex-1 {
            flex: 1;
        }

        /* Notification Styling */
        .notification {
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .notification.important {
            border-left-color: #ef4444;
        }

        .notification time {
            font-size: 0.875rem;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
                padding: 1.5rem;
                display: none;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1.5rem;
                box-sizing: border-box;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .sidebar a {
                font-size: 1rem;
            }

            .bg-white {
                padding: 1rem;
            }

            .bg-white h3 {
                font-size: 1rem;
            }

            .bg-white p {
                font-size: 1.2rem;
            }

            .logout-btn {
                padding: 0.7rem;
                font-size: 1rem;
            }

            /* Main Container Styles */
            .bg-white {
                background-color: #ffffff;
            }

            .p-6 {
                padding: 1.5rem;
            }

            .mt-6 {
                margin-top: 1.5rem;
            }

            .shadow {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .rounded {
                border-radius: 8px;
            }

            /* Title Styling */
            h2.text-xl {
                font-size: 1.25rem;
                font-weight: bold;
                color: #333333;
            }

            h2.font-bold {
                font-weight: 600;
            }

            /* Featured Election Card */
            #featuredelection {
                margin-top: 1rem;
            }

            #featuredelection .bg-gray-100 {
                background-color: #f7fafc;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            #featuredelection .bg-gray-100:hover {
                transform: scale(1.02);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }

            #featuredelection h3 {
                font-size: 1.125rem;
                font-weight: 600;
                color: #333333;
            }

            #featuredelection p {
                color: #4a5568;
                font-size: 0.875rem;
                line-height: 1.5;
            }

            #featuredelection .text-sm {
                font-size: 0.875rem;
                color: #6b7280;
            }

            #featuredelection .text-gray-500 {
                color: #6b7280;
            }

            /* Election Status Styling */
            .status-container {
                margin-top: 1rem;
            }

            .status-container .status-label {
                font-weight: 600;
                font-size: 0.875rem;
                color: #4a5568;
            }

            .status-container .status-value {
                font-size: 1rem;
                color: #2d3748;
            }

            .status-container .status-value.upcoming {
                color: #38a169;
            }

            .status-container .status-value.ongoing {
                color: #f6ad55;
            }

            .status-container .status-value.ended {
                color: #e53e3e;
            }

            /* Loading Text Styling */
            #featuredelection p.text-gray-500 {
                font-size: 1rem;
                color: #6b7280;
            }
            
        }
        
    </style>

</head>

<body>
    <div class="sidebar">
        <!-- Profile Section at top -->
        <div class="flex flex-col items-center py-6">
            <!-- Icon -->
            <div class="bg-white rounded-full p-3 mb-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5.121 17.804A11.953 11.953 0 0112 15c2.577 0 4.947.816 6.879 2.195M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>

            <!-- Role or UserID will appear here -->
            <h3 id="profileInfo" class="text-white text-sm font-semibold mb-1"></h3>

            <!-- View Profile link -->
            <a href="/profile" class="text-blue-300 hover:text-white text-sm underline">View Profile</a>
        </div>

        <h2>Voter Portal</h2>
        <ul>
            <li><a href="/vDashboard" class="active">Dashboard</a></li>
            <li><a href="/vote">Vote</a></li>
            <li><a href="/notice">Notices</a></li>
            <li><a href="/results">Results</a></li>
            <li><a href="/help">Help & Support</a></li>
        </ul>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="main-content flex-1 p-6">
        <h1 class="text-2xl font-bold">Welcome, <span id="voterName"></span></h1>

        <div class="grid grid-cols-3 gap-6 mt-4">
            <div class="bg-white p-4 rounded shadow">
                <h3 class="text-lg">Verification Status</h3>
                <p class="text-2xl font-bold"><span id="verificationStatus"></span></p>
                <p class="mt-2 text-sm text-gray-600" id="verificationMessage"></p>
            </div>

            <div class="bg-white p-4 rounded shadow">
                <h3 class="text-lg">Active Election</h3>
                <p class="text-2xl font-bold" id="activeElection">Loading...</p>
            </div>

            <div class="bg-white p-4 rounded shadow">
                <h3 class="text-lg">Your Polling Station</h3>
                <p id="locationDisplay" class="text-xl font-bold">Detecting location...</p>
                <button id="viewMapBtn" class="mt-2 text-blue-600 text-sm">View on Map</button>
            </div>
        </div>

        <div class="flex space-x-6">
            <!-- Notifications Section -->
            <div class="bg-white p-6 mt-6 shadow rounded flex-1">
                <h2 class="text-xl font-bold">Important Notifications</h2>
                <div id="notificationsContainer">
                    <!-- Notifications will be loaded here from the database -->
                    <p class="text-gray-500 py-4" id="noNotifications">Loading notifications...</p>
                </div>
            </div>

            <!-- Featured Election Section -->
            <div class="bg-white p-6 mt-6 shadow rounded flex-1">
                <h2 class="text-xl font-bold">Featured Election</h2>
                <div class="mt-4" id="featuredelection">
                    <!-- Candidates will be loaded here from the database -->
                    <p class="text-gray-500 py-4">Loading election...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-6 mt-6">
            <div class="bg-white p-6 shadow rounded">
                <h2 class="text-xl font-bold">Election Information</h2>
                <div class="mt-4" id="electionInfo">
                    <!-- Election information will be loaded here from the database -->
                    <p>Loading election information...</p>
                </div>
                <button onclick="location.href='/CandidateDetails'" class="mt-4 vote-btn">
                    View Candidates
                </button>
                
            </div>

            <div class="bg-white p-6 shadow rounded">
                <h2 class="text-xl font-bold">Quick Actions</h2>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <button id="verifyIdBtn" class="p-4 bg-blue-100 text-blue-800 rounded shadow hover:bg-blue-200">
                        Verify Your ID             </button>
                    <button type="button" class="p-4 bg-green-100 text-green-800 rounded shadow hover:bg-green-200"
                        onclick="window.location.href='/vote'">
                        Vote Preview
                    </button>
                    <button class="p-4 bg-purple-100 text-purple-800 rounded shadow hover:bg-purple-200">FAQ</button>
                    <button type="button" class="p-4 bg-yellow-100 text-yellow-800 rounded shadow hover:bg-yellow-200"
                        onclick="window.open('https://mail.google.com/mail/?view=cm&fs=1&to=timalsinadipendra125@gmail.com')">
                        Contact Support
                    </button>

                </div>
            </div>
            <div id="faqModal" class="faq-modal">
                <div class="faq-modal-content">
                    <span class="faq-close">&times;</span>
                    <h2 class="text-2xl font-bold mb-6">Frequently Asked Questions</h2>
            
                    <input type="text" class="faq-search" placeholder="Search FAQs...">
            
                    <div class="faq-categories">
                        <!-- FAQ categories will be populated here -->
                    </div>
                </div>      </div>
        </div>

        <script>
            const role = localStorage.getItem('role')?.toLowerCase();
            const userID = localStorage.getItem('userID');

            console.log('Role:', role);
            console.log('UserID:', userID);

            const profileInfo = document.getElementById('profileInfo');

            if (profileInfo) {
                if (role) {
                    profileInfo.innerText = role;   // First try showing role
                } else if (userID) {
                    profileInfo.innerText = userID; // If no role, fallback to userID
                } else {
                    profileInfo.innerText = 'Guest'; // fallback default
                }
            }

            // Replace the existing verifyIdBtn event listener with this updated version
                document.getElementById("verifyIdBtn").addEventListener("click", async () => {
                    // Show loading state
                    const button = document.getElementById("verifyIdBtn");
                    const originalText = button.innerText;
                    button.innerText = "Sending request...";
                    button.disabled = true;

                    const voterID = localStorage.getItem("userID");

                    if (!voterID) {
                        alert("User ID not found. Please log in again.");
                        button.innerText = originalText;
                        button.disabled = false;
                        return;
                    }

                    try {
                        const response = await fetch('/api/verify-request', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userID: voterID })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Show success message using a nicer notification instead of alert
                            showNotification(
                                "Verification request sent successfully!",
                                "Your request has been sent to the admin for review. You'll be notified once your ID is verified.",
                                "success"
                            );

                            // Update verification status immediately if needed
                            const verificationStatus = document.getElementById('verificationStatus');
                            const verificationMessage = document.getElementById('verificationMessage');

                            if (verificationStatus && verificationMessage) {
                                verificationStatus.innerText = 'Pending';
                                verificationStatus.className = 'text-2xl font-bold text-yellow-500';
                                verificationMessage.innerText = 'Your verification request has been sent to admin. Please wait for approval.';
                            }
                        } else {
                            showNotification(
                                "Request failed",
                                result.message || "Could not send verification request.",
                                "error"
                            );
                        }
                    } catch (error) {
                        console.error("Client error:", error);
                        showNotification(
                            "Connection error",
                            "Could not connect to the server. Please check your internet connection and try again.",
                            "error"
                        );
                    } finally {
                        // Restore button state
                        button.innerText = originalText;
                        button.disabled = false;
                    }
                });

                // Add this helper function for showing nice notifications
                function showNotification(title, message, type = "info") {
                    // Create notification container if it doesn't exist
                    let notificationContainer = document.getElementById("notification-container");

                    if (!notificationContainer) {
                        notificationContainer = document.createElement("div");
                        notificationContainer.id = "notification-container";
                        notificationContainer.style.position = "fixed";
                        notificationContainer.style.top = "20px";
                        notificationContainer.style.right = "20px";
                        notificationContainer.style.zIndex = "9999";
                        document.body.appendChild(notificationContainer);
                    }

                    // Create notification element
                    const notification = document.createElement("div");
                    notification.style.backgroundColor = type === "success" ? "#10b981" :
                        type === "error" ? "#ef4444" : "#3b82f6";
                    notification.style.color = "white";
                    notification.style.padding = "16px";
                    notification.style.borderRadius = "8px";
                    notification.style.boxShadow = "0 4px 6px rgba(0, 0, 0, 0.1)";
                    notification.style.marginBottom = "10px";
                    notification.style.width = "300px";
                    notification.style.position = "relative";

                    // Create close button
                    const closeBtn = document.createElement("button");
                    closeBtn.innerHTML = "Ã—";
                    closeBtn.style.position = "absolute";
                    closeBtn.style.top = "10px";
                    closeBtn.style.right = "10px";
                    closeBtn.style.background = "transparent";
                    closeBtn.style.border = "none";
                    closeBtn.style.color = "white";
                    closeBtn.style.fontSize = "20px";
                    closeBtn.style.cursor = "pointer";
                    closeBtn.onclick = () => {
                        notification.style.opacity = "0";
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    };

                    // Create content
                    notification.innerHTML = `
        <h3 style="margin-top: 0; margin-bottom: 8px; font-weight: bold;">${title}</h3>
        <p style="margin: 0;">${message}</p>
    `;

                    notification.appendChild(closeBtn);

                    // Add animation
                    notification.style.transition = "opacity 0.3s ease";
                    notification.style.opacity = "0";

                    // Add to container
                    notificationContainer.appendChild(notification);

                    // Trigger animation
                    setTimeout(() => {
                        notification.style.opacity = "1";
                    }, 10);

                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        notification.style.opacity = "0";
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    }, 5000);
                }

            // -------------------------------
            // Fetch and Load Notifications
            // -------------------------------
            async function loadNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    const data = await response.json();

                    const notificationsContainer = document.getElementById('notificationsContainer');
                    notificationsContainer.innerHTML = '';

                    if (data.success && data.notifications.length > 0) {
                        // Determine how many notifications to show (up to 5)
                        const notificationsToShow = data.notifications.slice(0, 5);
                        const hasMoreNotifications = data.notifications.length > 5;

                        // Create notification elements for the first 5 notifications
                        notificationsToShow.forEach(notification => {
                            const notificationElement = document.createElement('div');
                            notificationElement.className = 'p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors';

                            notificationElement.innerHTML = `
                    <h3 class="font-semibold text-lg">${notification.title}</h3>
                `;

                            notificationsContainer.appendChild(notificationElement);
                        });

                        // Add "See All" button if there are more than 5 notifications
                        if (hasMoreNotifications) {
                            const seeAllElement = document.createElement('div');
                            seeAllElement.className = 'mt-4 text-center';

                            seeAllElement.innerHTML = `
                    <a href="/notice" class="text-blue-600 hover:text-blue-800 font-medium">
                        See All Notifications (${data.notifications.length})
                    </a>
                `;

                            notificationsContainer.appendChild(seeAllElement);
                        }
                    } else {
                        notificationsContainer.innerHTML = '<p class="text-gray-500 py-4">No notifications found.</p>';
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    document.getElementById('notificationsContainer').innerHTML = '<p class="text-red-500 py-4">Failed to load notifications.</p>';
                }
            }

            // Fetch and Load active Election


            async function fetchActiveElections() {
                    try {
                        const res = await fetch('/api/active-elections');
                        if (!res.ok) return;
                        const data = await res.json();
                        document.getElementById('activeElection').textContent = data.count;
                    } catch (e) {
                        // silently fail
                    }
                }

                setInterval(fetchActiveElections, 1000);

            // Function to get the district or city name
                async function getLocationDetails(lat, lon) {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    // Get the district or county, or fallback to city/town
                    const district = data.address.district || data.address.county || data.address.city || "Unknown District";
                    const country = data.address.country || "Unknown Country";

                    // Check for Kathmandu (or any other major city) and return city info
                    if (country === "Nepal") {
                        if (district === "Kathmandu") {
                            return { location: `Kathmandu, Nepal`, isMajorCity: true };
                        }
                        return { location: `${district}, Nepal`, isMajorCity: false };
                    }

                    return { location: `${district}, ${country}`, isMajorCity: false };
                }

                // Automatically fetch the user's location when the page loads
                async function fetchAndDisplayLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                const { latitude, longitude } = position.coords;

                                // Now do reverse geocoding to fetch the district or city name
                                const locationDetails = await getLocationDetails(latitude, longitude);

                                // Display the location information on the page
                                document.getElementById('locationDisplay').textContent =
                                    `${locationDetails.location}`;

                                // Save whether the user is in a major city (like Kathmandu)
                                window.userIsInMajorCity = locationDetails.isMajorCity;
                            },
                            (error) => {
                                console.error('Geolocation error:', error);
                                document.getElementById('locationDisplay').textContent =
                                    'Location not available.';
                            }
                        );
                    } else {
                        alert('Geolocation is not supported by your browser.');
                    }
                }

                // Handle "View on Map" click
                document.getElementById('viewMapBtn').addEventListener('click', () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                const { latitude, longitude } = position.coords;

                                // Check if the user is in a major city like Kathmandu
                                if (window.userIsInMajorCity) {
                                    // If in Kathmandu, show the whole Kathmandu Valley area
                                    const mapUrl = `https://www.google.com/maps?q=Kathmandu+Valley,Nepal`;
                                    window.open(mapUrl, '_blank');
                                } else {
                                    // Open the map at the user's exact location
                                    const mapUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
                                    window.open(mapUrl, '_blank');
                                }
                            },
                            (error) => {
                                console.error('Geolocation error:', error);
                                alert('Unable to retrieve location for map.');
                            }
                        );
                    } else {
                        alert('Geolocation is not supported by your browser.');
                        window.open('https://www.google.com/maps/place/Nepal', '_blank');
                    }
                });


            // -------------------------------
                // Fetch and Load Election Details
                // -------------------------------
                async function loadElectionDetails() {
                    try {
                        const response = await fetch('/api/featuredelection');
                        const data = await response.json();

                        const featuredElection = document.getElementById('featuredelection');
                        featuredElection.innerHTML = ''; // Clear previous content

                        if (data.success) {
                            const elections = data.elections;  // Array of ongoing elections

                            // Loop through each election and display it
                            elections.forEach((election) => {
                                featuredElection.innerHTML += `
                    <div class="p-4 bg-blue-100 rounded mb-4">
                        <h3 class="text-lg font-semibold">${election.name}</h3>
                        <p class="text-gray-700 mt-2">${election.description ?? 'No description provided.'}</p>
                        <div class="text-sm text-gray-500 mt-2">
                            <p>Status: <span class="font-medium">${election.status}</span></p>
                            <p>Date: ${new Date(election.start_time).toLocaleDateString()}</p>
                            <p>Time: ${new Date(election.start_time).toLocaleTimeString()} - ${new Date(election.end_time).toLocaleTimeString()}</p>
                        </div>
                    </div>
                `;
                            });
                        } else {
                            featuredElection.innerHTML = `<p class="text-gray-500 py-4">${data.message}</p>`;
                        }
                    } catch (error) {
                        console.error('Error loading featured election:', error);
                        document.getElementById('featuredelection').innerHTML = '<p class="text-red-500 py-4">Failed to load election data.</p>';
                    }
                }


            document.addEventListener('DOMContentLoaded', loadElectionDetails);



            // -------------------------------
            // Fetch and Load Voter Details
            // -------------------------------
            async function loadVoterDetailsLive() {
                    const voterID = localStorage.getItem('userID');
                    const role = localStorage.getItem('role');

                    if (role?.toLowerCase() !== 'voter' || !voterID) {
                        document.getElementById('voterName').innerText = 'Role not authorized';
                        return;
                    }

                    try {
                        const response = await fetch(`/api/user/profile?id=${voterID}`);
                        const result = await response.json();

                        if (result.success && result.user.role.toLowerCase() === 'voter') {
                            const { name, status } = result.user;
                            document.getElementById('voterName').innerText = name;

                            const verificationStatus = document.getElementById('verificationStatus');
                            const verificationMessage = document.getElementById('verificationMessage');

                            switch (status) {
                                case 'Pending':
                                    verificationStatus.innerText = 'Pending';
                                    verificationStatus.className = 'text-2xl font-bold text-yellow-500';
                                    verificationMessage.innerText = 'Your verification is pending. Please wait for approval.';
                                    verificationMessage.className = 'text-sm text-gray-600 mt-2';
                                    break;

                                case 'Verified':
                                    verificationStatus.innerText = 'Verified';
                                    verificationStatus.className = 'text-2xl font-bold text-green-500';
                                    verificationMessage.innerText = 'Your account has been verified. You can now vote in elections.';
                                    verificationMessage.className = 'text-sm text-gray-600 mt-2';
                                    break;

                                case 'Rejected':
                                    verificationStatus.innerText = 'Rejected';
                                    verificationStatus.className = 'text-2xl font-bold text-red-500';
                                    verificationMessage.innerText = 'Your verification was rejected. Please contact support for assistance.';
                                    verificationMessage.className = 'text-sm text-gray-600 mt-2';
                                    break;

                                default:
                                    verificationStatus.innerText = 'Unknown';
                                    verificationStatus.className = 'text-2xl font-bold text-gray-500';
                                    verificationMessage.innerText = 'Unable to determine verification status.';
                                    verificationMessage.className = 'text-sm text-gray-600 mt-2';
                            }

                        } else {
                            document.getElementById('voterName').innerText = 'User not found or not a voter';
                        }
                    } catch (error) {
                        console.error('Error fetching voter details:', error);
                        document.getElementById('voterName').innerText = 'Error loading voter';
                    }
                }


                // Run once initially
                loadVoterDetailsLive();

                // Then repeat every second
                setInterval(loadVoterDetailsLive, 1000);



                const faqData = {
                        "Voting Process": [
                            {
                                question: "How do I cast my vote?",
                                answer: "To cast your vote, login to your account, navigate to the Vote section, select your preferred candidate, and confirm your choice. Make sure your verification is completed before the election day."
                            },
                            {
                                question: "Can I change my vote after submitting?",
                                answer: "No, once you've submitted your vote, it cannot be changed. Please carefully review your selection before confirming."
                            },
                            {
                                question: "What if I'm unable to vote online on election day?",
                                answer: "If you encounter technical difficulties on election day, please contact our support team immediately. In some elections, there might be provisions for alternative voting methods."
                            }
                        ],
                        "Verification & Security": [
                            {
                                question: "How do I verify my voter ID?",
                                answer: "Click on the 'Verify Your ID' button on your dashboard. You'll need to submit your identification documents for verification. Once approved by the admin, your status will be updated to 'Verified'."
                            },
                            {
                                question: "How secure is the online voting system?",
                                answer: "Our system employs advanced encryption, two-factor authentication, and blockchain technology to ensure vote integrity and security. Every vote is anonymized and protected against tampering."
                            },
                            {
                                question: "What happens if I forget my password?",
                                answer: "Use the 'Forgot Password' option on the login page. A password reset link will be sent to your registered email address. For security reasons, you'll need to verify your identity again after resetting your password."
                            }
                        ],
                        "Technical Issues": [
                            {
                                question: "The website is not loading properly. What should I do?",
                                answer: "First, try refreshing the page or clearing your browser cache. If the issue persists, try using a different browser or device. If you still experience problems, contact our technical support team."
                            },
                            {
                                question: "How do I report a bug or technical issue?",
                                answer: "Click on the 'Contact Support' button on your dashboard, or email us directly at support@votingsystem.com. Please include as many details as possible, including screenshots if applicable."
                            }
                        ],
                        "Results & Notifications": [
                            {
                                question: "When will the election results be announced?",
                                answer: "Results are typically announced within 24 hours after the election closes. You'll receive a notification, and results will be available in the Results section of the portal."
                            },
                            {
                                question: "How do I get notifications about upcoming elections?",
                                answer: "Notifications about upcoming elections and important deadlines are automatically sent to your registered email address. You can also check the Notifications section on your dashboard."
                            }
                        ]
                    };

                    // Create and initialize the FAQ modal
                    function createFAQModal() {
                            // Create modal container
                            const modal = document.createElement('div');
                            modal.id = 'faqModal';
                            modal.className = 'faq-modal';

                            // Create modal content
                            modal.innerHTML = `
        <div class="faq-modal-content">
            <span class="faq-close">&times;</span>
            <h2 class="text-2xl font-bold mb-6">Frequently Asked Questions</h2>
            
            <input type="text" class="faq-search" placeholder="Search FAQs...">
            
            <div class="faq-categories">
                <!-- FAQ categories will be populated here -->
            </div>
        </div>
    `;

                            // Append to body
                            document.body.appendChild(modal);

                            // Add event listeners - make sure this works by using direct function
                            document.querySelector('.faq-close').onclick = function () {
                                document.getElementById('faqModal').style.display = 'none';
                            };

                            // Close modal when clicking outside the content
                            window.onclick = function (event) {
                                if (event.target == document.getElementById('faqModal')) {
                                    document.getElementById('faqModal').style.display = 'none';
                                }
                            };

                            // Add search functionality
                            document.querySelector('.faq-search').addEventListener('input', function () {
                                const searchTerm = this.value.toLowerCase();
                                searchFAQs(searchTerm);
                            });

                            // Populate FAQ content
                            populateFAQs();
                        }

                        // Populate FAQ categories and questions
                        function populateFAQs() {
                            const categoriesContainer = document.querySelector('.faq-categories');

                            Object.keys(faqData).forEach(category => {
                                const categorySection = document.createElement('div');
                                categorySection.className = 'faq-category';

                                categorySection.innerHTML = `
            <h3 class="faq-category-title">${category}</h3>
            <div class="faq-items">
                ${faqData[category].map((item, index) => `
                    <div class="faq-card" data-category="${category}" data-index="${index}">
                        <div class="faq-question">${item.question}</div>
                        <div class="faq-answer">${item.answer}</div>
                    </div>
                `).join('')}
            </div>
        `;

                                categoriesContainer.appendChild(categorySection);
                            });

                            // Add event listeners for FAQ accordions
                            document.querySelectorAll('.faq-question').forEach(question => {
                                question.addEventListener('click', () => {
                                    const card = question.parentElement;
                                    const isActive = card.classList.contains('active');

                                    // Close all other open FAQs
                                    document.querySelectorAll('.faq-card.active').forEach(openCard => {
                                        if (openCard !== card) {
                                            openCard.classList.remove('active');
                                        }
                                    });

                                    // Toggle current FAQ
                                    card.classList.toggle('active', !isActive);
                                });
                            });
                        }

                        // Search FAQs function
                        function searchFAQs(searchTerm) {
                            // Get all FAQ cards and categories
                            const allFAQs = document.querySelectorAll('.faq-card');
                            const categories = document.querySelectorAll('.faq-category');

                            // Convert search term to lowercase for case-insensitive comparison
                            searchTerm = searchTerm.toLowerCase();

                            if (!searchTerm) {
                                // If search is empty, show all FAQs and reset their active state
                                allFAQs.forEach(faq => {
                                    faq.style.display = 'block';
                                    faq.classList.remove('active');
                                });

                                categories.forEach(category => {
                                    category.style.display = 'block';
                                });
                                return;
                            }

                            // For each FAQ card, check if question or answer contains the search term
                            allFAQs.forEach(faq => {
                                const question = faq.querySelector('.faq-question').textContent.toLowerCase();
                                const answer = faq.querySelector('.faq-answer').textContent.toLowerCase();

                                if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                                    faq.style.display = 'block';
                                    // Expand the card if it matches search
                                    faq.classList.add('active');
                                } else {
                                    faq.style.display = 'none';
                                    faq.classList.remove('active');
                                }
                            });

                            // Show/hide categories based on whether they have visible FAQs
                            categories.forEach(category => {
                                const visibleFAQs = Array.from(category.querySelectorAll('.faq-card')).filter(
                                    faq => faq.style.display !== 'none'
                                );

                                category.style.display = visibleFAQs.length > 0 ? 'block' : 'none';
                            });
                        }

                        // Initialize the FAQ functionality
                        window.addEventListener('DOMContentLoaded', function () {
                            // Create the FAQ modal first
                            createFAQModal();

                            // After modal is created, connect the FAQ button
                            const faqButton = document.querySelector('.bg-purple-100');
                            if (faqButton) {
                                faqButton.addEventListener('click', function () {
                                    const faqModal = document.getElementById('faqModal');
                                    if (faqModal) {
                                        faqModal.style.display = 'block';
                                    }
                                });
                            }

                            // Make sure close button works
                            const closeBtn = document.querySelector('.faq-close');
                            if (closeBtn) {
                                closeBtn.addEventListener('click', function () {
                                    document.getElementById('faqModal').style.display = 'none';
                                });
                            }
                        });


            function logout() {
                    const confirmLogout = confirm("Are you sure you want to logout?");
                    if (!confirmLogout) return;

                    fetch('/api/logout', {
                        method: 'POST',
                        credentials: 'include'
                    }).finally(() => {
                        localStorage.clear();
                        sessionStorage.clear();

                        if (window.history && window.history.pushState) {
                            window.history.pushState(null, "", window.location.href);
                            window.onpopstate = function () {
                                window.history.pushState(null, "", window.location.href);
                            };
                        }

                        window.location.href = "/login";
                    });
                }


                window.addEventListener('DOMContentLoaded', () => {
                    document.getElementById('logoutBtn').addEventListener('click', logout);
                });

            

            // -------------------------------
            // Initialize on Page Load
            // -------------------------------
            window.addEventListener('DOMContentLoaded', () => {
                window.onload = fetchAndDisplayLocation;
                loadNotifications();
                fetchActiveElections();
                loadElectionDetails();
                loadVoterDetails();
            });
        </script>
    </div>
</body>

</html>